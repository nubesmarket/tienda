<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación de Tienda Multivendedor (GitHub Pages)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM UMD builds from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in the browser (for development/simple deployments) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Get React and ReactDOM from the global window object
        const React = window.React;
        const ReactDOM = window.ReactDOM;

        // Mock data for demonstration purposes
        const mockProducts = [
            { id: 'p1', name: 'Camiseta de Algodón', description: 'Camiseta suave y cómoda.', price: 15.99, vendorId: 'v1', imageUrl: 'https://placehold.co/100x100/AEC6CF/000000?text=Camiseta', stock: 10 },
            { id: 'p2', name: 'Pantalones Vaqueros', description: 'Vaqueros clásicos, corte recto.', price: 45.00, vendorId: 'v1', imageUrl: 'https://placehold.co/100x100/FFDDC1/000000?text=Vaqueros', stock: 5 },
            { id: 'p3', name: 'Libro de Cocina', description: 'Recetas saludables y fáciles.', price: 22.50, vendorId: 'v2', imageUrl: 'https://placehold.co/100x100/B3E0FF/000000?text=Libro', stock: 20 },
            { id: 'p4', name: 'Auriculares Inalámbricos', description: 'Sonido de alta calidad, batería duradera.', price: 79.99, vendorId: 'v3', imageUrl: 'https://placehold.co/100x100/D4A6C8/000000?text=Auriculares', stock: 3 },
            { id: 'p5', name: 'Cafetera Espresso', description: 'Prepara tu café favorito en casa.', price: 120.00, vendorId: 'v2', imageUrl: 'https://placehold.co/100x100/C1FFC1/000000?text=Cafetera', stock: 0 }, // Example of out of stock
        ];

        // Initial mock vendors (now a state to allow dynamic addition)
        const initialMockVendors = [
            { id: 'v1', name: 'Tienda de Ropa Cool', password: 'password123' },
            { id: 'v2', name: 'Gadgets y Libros', password: 'secret456' },
            { id: 'v3', name: 'Electrónica Pro', password: 'pro_pass' }, // Added a password for v3 for consistency
        ];

        // Initial mock orders (empty for a fresh start)
        const initialMockOrders = [];

        function App() {
            // State to manage the current user's role: 'customer', 'vendor', 'admin', or null (for login screen)
            const [currentUser, setCurrentUser] = React.useState(null); // { role: 'customer', id: 'c1' } or { role: 'vendor', id: 'v1' } or { role: 'admin' }
            // State to manage all products in the system
            const [products, setProducts] = React.useState(mockProducts);
            // State to manage all orders in the system
            const [orders, setOrders] = React.useState(initialMockOrders);
            // State for the customer's shopping cart
            const [cart, setCart] = React.useState([]);
            // State for displaying messages to the user
            const [message, setMessage] = React.useState('');
            // State to manage the current view within a role (e.g., 'browse', 'cart', 'add-product')
            const [currentView, setCurrentView] = React.useState('browse');
            // State for the product being edited (if any)
            const [editingProduct, setEditingProduct] = React.useState(null);
            // State for vendors, now dynamic
            const [vendors, setVendors] = React.useState(initialMockVendors);


            // Simulate API calls with a delay
            const simulateApiCall = (data, delay = 500) => {
                return new Promise(resolve => setTimeout(() => resolve(data), delay));
            };

            // --- Customer Functions ---
            const handleAddToCart = async (product) => {
                if (product.stock <= 0) {
                    setMessage(`Lo sentimos, '${product.name}' está agotado.`);
                    return;
                }

                setMessage('Añadiendo producto al carrito...');
                await simulateApiCall(); // Simulate network request

                setCart(prevCart => {
                    const existingItem = prevCart.find(item => item.id === product.id);
                    if (existingItem) {
                        // Check if adding more would exceed stock
                        if (existingItem.quantity + 1 > product.stock) {
                            setMessage(`No hay suficiente stock para añadir otra unidad de '${product.name}'.`);
                            return prevCart; // Don't update cart if stock is insufficient
                        }
                        return prevCart.map(item =>
                            item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
                        );
                    }
                    return [...prevCart, { ...product, quantity: 1 }];
                });
                setMessage(`${product.name} añadido al carrito.`);
            };

            const handleRemoveFromCart = (productId) => {
                setCart(prevCart => prevCart.filter(item => item.id !== productId));
                setMessage('Producto eliminado del carrito.');
            };

            const handleUpdateCartQuantity = (productId, quantity) => {
                setCart(prevCart => {
                    const productInCart = prevCart.find(item => item.id === productId);
                    const originalProduct = products.find(p => p.id === productId);

                    if (!productInCart || !originalProduct) return prevCart;

                    if (quantity <= 0) {
                        return prevCart.filter(item => item.id !== productId);
                    }
                    // Check if new quantity exceeds stock
                    if (quantity > originalProduct.stock) {
                        setMessage(`No hay suficiente stock para ${originalProduct.name}. Stock disponible: ${originalProduct.stock}`);
                        return prevCart; // Don't update if stock is insufficient
                    }
                    return prevCart.map(item =>
                        item.id === productId ? { ...item, quantity: quantity } : item
                    );
                });
            };

            const handlePlaceOrder = async () => {
                if (cart.length === 0) {
                    setMessage('El carrito está vacío.');
                    return;
                }

                setMessage('Procesando pedido...');
                await simulateApiCall(); // Simulate network request

                const newOrderId = `o${orders.length + 1}`;
                const newOrder = {
                    id: newOrderId,
                    customerId: currentUser.id,
                    items: cart,
                    total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                    status: 'Pendiente',
                    timestamp: new Date().toISOString(),
                };

                // Update product stock and remove if out of stock
                setProducts(prevProducts => {
                    let updatedProducts = [...prevProducts];
                    cart.forEach(cartItem => {
                        const productIndex = updatedProducts.findIndex(p => p.id === cartItem.id);
                        if (productIndex !== -1) {
                            const currentProduct = updatedProducts[productIndex];
                            const newStock = currentProduct.stock - cartItem.quantity;
                            if (newStock <= 0) {
                                // Remove product if stock is 0 or less
                                updatedProducts = updatedProducts.filter(p => p.id !== cartItem.id);
                                setMessage(`Producto '${currentProduct.name}' agotado y eliminado de la tienda.`);
                            } else {
                                // Update stock
                                updatedProducts[productIndex] = { ...currentProduct, stock: newStock };
                            }
                        }
                    });
                    return updatedProducts;
                });

                setOrders(prevOrders => [...prevOrders, newOrder]);
                setCart([]); // Clear cart after placing order
                setMessage('¡Pedido realizado con éxito!');
                setCurrentView('browse'); // Go back to browsing after order
            };

            // --- Vendor Functions ---
            const handleAddOrUpdateProduct = async (productData) => {
                setMessage('Guardando producto...');
                await simulateApiCall(); // Simulate network request

                if (productData.stock <= 0) {
                    // If stock is 0 or less, remove the product
                    setProducts(prevProducts => prevProducts.filter(p => p.id !== productData.id));
                    setMessage(`Producto '${productData.name}' eliminado por falta de stock.`);
                } else if (productData.id) {
                    // Update existing product
                    setProducts(prevProducts =>
                        prevProducts.map(p => (p.id === productData.id ? productData : p))
                    );
                    setMessage('Producto actualizado con éxito.');
                } else {
                    // Add new product
                    const newProductId = `p${products.length + 1}`;
                    const newProduct = { ...productData, id: newProductId, vendorId: currentUser.id };
                    setProducts(prevProducts => [...prevProducts, newProduct]);
                    setMessage('Producto añadido con éxito.');
                }
                setEditingProduct(null); // Clear editing state
                setCurrentView('vendor-products'); // Go back to vendor products list
            };

            const handleDeleteProduct = async (productId) => {
                setMessage('Eliminando producto...');
                await simulateApiCall(); // Simulate network request
                setProducts(prevProducts => prevProducts.filter(p => p.id !== productId));
                setMessage('Producto eliminado.');
            };

            const handleUpdateOrderStatus = async (orderId, newStatus) => {
                setMessage('Actualizando estado del pedido...');
                await simulateApiCall(); // Simulate network request
                setOrders(prevOrders =>
                    prevOrders.map(order =>
                        order.id === orderId ? { ...order, status: newStatus } : order
                    )
                );
                setMessage(`Estado del pedido ${orderId} actualizado a "${newStatus}".`);
            };

            // --- General UI Components ---
            const Header = ({ user, onLogout }) => (
                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-b-lg shadow-lg flex justify-between items-center">
                    <h1 className="text-2xl font-bold">Simulación de Bot de Telegram</h1>
                    {user && (
                        <div className="flex items-center space-x-4">
                            <span className="text-lg">
                                Rol: <span className="font-semibold capitalize">{user.role}</span>
                                {user.id && ` (ID: ${user.id})`}
                            </span>
                            <button
                                onClick={onLogout}
                                className="bg-white text-blue-600 px-4 py-2 rounded-full shadow-md hover:bg-gray-100 transition duration-300"
                            >
                                Cerrar Sesión
                            </button>
                        </div>
                    )}
                </div>
            );

            const MessageDisplay = ({ msg }) => (
                <div className={`mt-4 p-3 rounded-lg text-center ${msg ? 'bg-blue-100 text-blue-800' : 'hidden'}`}>
                    {msg}
                </div>
            );

            // --- Views based on currentUser role ---

            const LoginScreen = () => {
                const [selectedVendorId, setSelectedVendorId] = React.useState(null); // Used for login after ID is found
                const [password, setPassword] = React.useState('');
                const [loginError, setLoginError] = React.useState('');
                const [showRegisterForm, setShowRegisterForm] = React.useState(false);
                const [showVendorLoginFlow, setShowVendorLoginFlow] = React.useState(false); // New state to control vendor login flow visibility
                const [vendorIdToSearch, setVendorIdToSearch] = React.useState(''); // New state for the ID input field
                const [currentVendorAttempt, setCurrentVendorAttempt] = React.useState(null); // Stores the vendor object found by ID search

                // Function to handle the initial click on "Soy Vendedor" button
                const handleInitialVendorClick = () => {
                    setShowVendorLoginFlow(true); // Show the vendor ID search input
                    setShowRegisterForm(false); // Hide the registration form if it was open
                    setLoginError(''); // Clear any previous login errors
                    setVendorIdToSearch(''); // Clear the ID input field
                    setCurrentVendorAttempt(null); // Clear any previously found vendor
                    setSelectedVendorId(null); // Clear selected vendor ID
                    setPassword(''); // Clear password field
                };

                // Function to search for a vendor by ID
                const handleSearchVendorId = () => {
                    const found = vendors.find(v => v.id.toLowerCase() === vendorIdToSearch.toLowerCase());
                    if (found) {
                        setCurrentVendorAttempt(found); // Set the found vendor
                        setSelectedVendorId(found.id); // Set selectedVendorId for password check
                        setLoginError(''); // Clear any previous errors
                    } else {
                        setCurrentVendorAttempt(null); // No vendor found
                        setSelectedVendorId(null);
                        setLoginError('ID de vendedor no encontrado.'); // Display error
                    }
                    setPassword(''); // Clear password field on new ID search
                };

                // Function to handle password submission for a found vendor
                const handlePasswordSubmit = () => {
                    if (currentVendorAttempt && currentVendorAttempt.password === password) {
                        setCurrentUser({ role: 'vendor', id: currentVendorAttempt.id }); // Log in the vendor
                        setLoginError(''); // Clear errors
                    } else {
                        setLoginError('Contraseña incorrecta. Inténtalo de nuevo.'); // Display password error
                    }
                };

                // Function to handle new vendor registration
                const handleRegisterVendor = async (storeName, password) => {
                    setMessage('Registrando vendedor...');
                    await simulateApiCall();

                    const newVendorId = `v${vendors.length + 1}`;
                    const newVendor = {
                        id: newVendorId,
                        name: storeName,
                        password: password,
                    };

                    // Check for duplicate store name (simple check)
                    if (vendors.some(v => v.name.toLowerCase() === storeName.toLowerCase())) {
                        setLoginError('Ya existe una tienda con ese nombre. Por favor, elige otro.');
                        setMessage('');
                        return;
                    }

                    setVendors(prevVendors => [...prevVendors, newVendor]);
                    setMessage(`¡Vendedor '${storeName}' registrado con éxito! Tu ID es: ${newVendorId}. Ahora puedes iniciar sesión.`);
                    setShowRegisterForm(false); // Hide registration form
                    setShowVendorLoginFlow(false); // Go back to initial login options
                    setLoginError(''); // Clear any previous login errors
                };

                // Function to go back to the main login options
                const handleBackToMainLogin = () => {
                    setShowVendorLoginFlow(false); // Hide vendor login flow
                    setShowRegisterForm(false); // Hide registration form
                    setLoginError(''); // Clear errors
                    setVendorIdToSearch(''); // Clear ID input
                    setCurrentVendorAttempt(null); // Clear found vendor
                    setSelectedVendorId(null); // Clear selected vendor ID
                    setPassword(''); // Clear password
                };

                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full">
                            <h2 className="text-3xl font-extrabold text-gray-800 mb-6">Selecciona tu Rol</h2>
                            <div className="space-y-4">
                                {/* Initial login options */}
                                {!showVendorLoginFlow && !showRegisterForm && (
                                    <>
                                        <button
                                            onClick={() => setCurrentUser({ role: 'customer', id: 'c1' })}
                                            className="w-full bg-green-500 text-white py-3 px-6 rounded-lg text-xl font-semibold hover:bg-green-600 transition duration-300 transform hover:scale-105 shadow-md"
                                        >
                                            Soy Cliente
                                        </button>
                                        <button
                                            onClick={handleInitialVendorClick}
                                            className="w-full bg-indigo-500 text-white py-3 px-6 rounded-lg text-xl font-semibold hover:bg-indigo-600 transition duration-300 transform hover:scale-105 shadow-md"
                                        >
                                            Soy Vendedor
                                        </button>
                                        <button
                                            onClick={() => setShowRegisterForm(true)}
                                            className="w-full bg-purple-500 text-white py-3 px-6 rounded-lg text-xl font-semibold hover:bg-purple-600 transition duration-300 transform hover:scale-105 shadow-md"
                                        >
                                            Registrarme como Vendedor
                                        </button>
                                        <button
                                            onClick={() => setCurrentUser({ role: 'admin' })}
                                            className="w-full bg-red-500 text-white py-3 px-6 rounded-lg text-xl font-semibold hover:bg-red-600 transition duration-300 transform hover:scale-105 shadow-md"
                                >
                                            Soy Administrador
                                        </button>
                                    </>
                                )}

                                {/* Vendor Login Flow (ID search and password) */}
                                {showVendorLoginFlow && !showRegisterForm && (
                                    <div className="mt-4 p-4 bg-indigo-100 rounded-lg shadow-inner">
                                        <p className="text-indigo-800 font-semibold mb-2">Ingresa tu ID de Vendedor:</p>
                                        <div className="flex space-x-2 mb-2">
                                            <input
                                                type="text"
                                                value={vendorIdToSearch}
                                                onChange={(e) => setVendorIdToSearch(e.target.value)}
                                                placeholder="Ej: v1, v2, nuevo_vendedor"
                                                className="w-full p-2 border border-indigo-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                            />
                                            <button
                                                onClick={handleSearchVendorId}
                                                className="bg-indigo-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-800 transition duration-300"
                                            >
                                                Buscar
                                            </button>
                                        </div>
                                        {currentVendorAttempt && (
                                            <div className="mt-4">
                                                <p className="text-indigo-800 font-semibold mb-2">Ingresa la contraseña para {currentVendorAttempt.name}:</p>
                                                <input
                                                    type="password"
                                                    value={password}
                                                    onChange={(e) => setPassword(e.target.value)}
                                                    placeholder="Contraseña"
                                                    className="w-full p-2 border border-indigo-300 rounded-md mb-2 focus:ring-indigo-500 focus:border-indigo-500"
                                                />
                                                <button
                                                    onClick={handlePasswordSubmit}
                                                    className="w-full bg-indigo-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-800 transition duration-300"
                                                >
                                                    Acceder
                                                </button>
                                            </div>
                                        )}
                                        {loginError && <p className="text-red-600 mt-2 text-sm">{loginError}</p>}
                                        <button
                                            onClick={handleBackToMainLogin}
                                            className="mt-4 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                                        >
                                            Volver
                                        </button>
                                    </div>
                                )}

                                {/* Vendor Registration Form */}
                                {showRegisterForm && (
                                    <VendorRegistrationForm
                                        onRegister={handleRegisterVendor}
                                        onCancel={handleBackToMainLogin} // Use handleBackToMainLogin to go back to initial options
                                        registrationError={loginError}
                                    />
                                )}
                            </div>
                            <p className="text-gray-600 mt-6 text-sm">
                                Esta es una simulación. En un bot real, la autenticación sería diferente.
                            </p>
                        </div>
                    </div>
                );
            };

            // New Component for Vendor Registration
            const VendorRegistrationForm = ({ onRegister, onCancel, registrationError }) => {
                const [storeName, setStoreName] = React.useState('');
                const [password, setPassword] = React.useState('');
                const [confirmPassword, setConfirmPassword] = React.useState('');
                const [formError, setFormError] = React.useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    setFormError(''); // Clear previous errors

                    if (!storeName || !password || !confirmPassword) {
                        setFormError('Todos los campos son obligatorios.');
                        return;
                    }
                    if (password.length < 6) {
                        setFormError('La contraseña debe tener al menos 6 caracteres.');
                        return;
                    }
                    if (password !== confirmPassword) {
                        setFormError('Las contraseñas no coinciden.');
                        return;
                    }
                    onRegister(storeName, password);
                };

                return (
                    <div className="mt-4 p-6 bg-blue-100 rounded-xl shadow-inner text-left">
                        <h3 className="text-2xl font-bold text-blue-800 mb-4">Registro de Vendedor</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="regStoreName" className="block text-blue-700 font-semibold mb-1">Nombre de la Tienda</label>
                                <input
                                    type="text"
                                    id="regStoreName"
                                    value={storeName}
                                    onChange={(e) => setStoreName(e.target.value)}
                                    className="w-full p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Mi Tienda Genial"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="regPassword" className="block text-blue-700 font-semibold mb-1">Contraseña</label>
                                <input
                                    type="password"
                                    id="regPassword"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Mínimo 6 caracteres"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="regConfirmPassword" className="block text-blue-700 font-semibold mb-1">Confirmar Contraseña</label>
                                <input
                                    type="password"
                                    id="regConfirmPassword"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    className="w-full p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Repite la contraseña"
                                    required
                                />
                            </div>
                            {formError && <p className="text-red-600 text-sm">{formError}</p>}
                            {registrationError && <p className="text-red-600 text-sm">{registrationError}</p>}
                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                                >
                                    Registrar Tienda
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };


            const CustomerDashboard = () => {
                const totalCartItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                // Filter out products with 0 stock for customer view
                const availableProducts = products.filter(p => p.stock > 0);

                return (
                    <div className="p-6 bg-gray-50 min-h-screen">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">Tienda para Clientes</h2>
                            <div className="flex space-x-4">
                                <button
                                    onClick={() => setCurrentView('browse')}
                                    className={`px-5 py-2 rounded-lg font-semibold transition duration-300 ${currentView === 'browse' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Explorar Productos
                                </button>
                                <button
                                    onClick={() => setCurrentView('cart')}
                                    className={`relative px-5 py-2 rounded-lg font-semibold transition duration-300 ${currentView === 'cart' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Ver Carrito
                                    {totalCartItems > 0 && (
                                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">
                                            {totalCartItems}
                                        </span>
                                    )}
                                </button>
                            </div>
                        </div>

                        <MessageDisplay msg={message} />

                        {currentView === 'browse' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                                {availableProducts.map(product => (
                                    <div key={product.id} className="bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition duration-300 flex flex-col">
                                        <img src={product.imageUrl} alt={product.name} className="w-full h-48 object-cover" onError={(e) => e.target.src = 'https://placehold.co/100x100/CCCCCC/000000?text=Error'} />
                                        <div className="p-5 flex flex-col flex-grow">
                                            <h3 className="text-xl font-semibold text-gray-900 mb-2">{product.name}</h3>
                                            <p className="text-gray-600 text-sm mb-3 flex-grow">{product.description}</p>
                                            <p className="text-gray-700 font-bold text-lg mb-3">${product.price.toFixed(2)}</p>
                                            <p className="text-sm text-gray-500 mb-2">Vendedor: {vendors.find(v => v.id === product.vendorId)?.name || 'Desconocido'}</p>
                                            <p className={`text-sm font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                Stock: {product.stock > 0 ? product.stock : 'Agotado'}
                                            </p>
                                            <button
                                                onClick={() => handleAddToCart(product)}
                                                className="mt-auto bg-blue-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                                                disabled={product.stock <= 0}
                                            >
                                                Añadir al Carrito
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {availableProducts.length === 0 && (
                                    <p className="text-center text-gray-600 col-span-full">No hay productos disponibles en stock.</p>
                                )}
                            </div>
                        )}

                        {currentView === 'cart' && (
                            <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                                <h3 className="text-2xl font-bold text-gray-800 mb-5">Tu Carrito de Compras</h3>
                                {cart.length === 0 ? (
                                    <p className="text-gray-600 text-center py-4">Tu carrito está vacío. ¡Añade algunos productos!</p>
                                ) : (
                                    <>
                                        <div className="space-y-4">
                                            {cart.map(item => (
                                                <div key={item.id} className="flex items-center justify-between border-b pb-4 last:border-b-0 last:pb-0">
                                                    <div className="flex items-center space-x-4">
                                                        <img src={item.imageUrl} alt={item.name} className="w-16 h-16 rounded-md object-cover" onError={(e) => e.target.src = 'https://placehold.co/100x100/CCCCCC/000000?text=Error'} />
                                                        <div>
                                                            <p className="font-semibold text-gray-900">{item.name}</p>
                                                            <p className="text-gray-600 text-sm">Vendedor: {vendors.find(v => v.id === item.vendorId)?.name}</p>
                                                            <p className="text-gray-700">${item.price.toFixed(2)} c/u</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center space-x-3">
                                                        <button
                                                            onClick={() => handleUpdateCartQuantity(item.id, item.quantity - 1)}
                                                            className="bg-gray-200 text-gray-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-300 transition"
                                                        >-</button>
                                                        <span className="font-semibold">{item.quantity}</span>
                                                        <button
                                                            onClick={() => handleUpdateCartQuantity(item.id, item.quantity + 1)}
                                                            className="bg-gray-200 text-gray-700 rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-300 transition"
                                                        >+</button>
                                                        <button
                                                            onClick={() => handleRemoveFromCart(item.id)}
                                                            className="ml-4 text-red-500 hover:text-red-700 transition"
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-right mt-6 pt-4 border-t-2 border-gray-100">
                                            <p className="text-2xl font-bold text-gray-900">Total: ${cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2)}</p>
                                            <button
                                                onClick={handlePlaceOrder}
                                                className="mt-6 bg-green-500 text-white px-8 py-3 rounded-lg text-xl font-semibold hover:bg-green-600 transition duration-300 shadow-lg"
                                            >
                                                Proceder al Pago
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const VendorDashboard = () => {
                const vendorProducts = products.filter(p => p.vendorId === currentUser.id);
                const vendorOrders = orders.filter(o => o.items.some(item => item.vendorId === currentUser.id));

                const handleEditProduct = (product) => {
                    setEditingProduct(product);
                    setCurrentView('add-edit-product');
                };

                return (
                    <div className="p-6 bg-gray-50 min-h-screen">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">Panel de Vendedor</h2>
                            <div className="flex space-x-4">
                                <button
                                    onClick={() => { setCurrentView('vendor-products'); setEditingProduct(null); }}
                                    className={`px-5 py-2 rounded-lg font-semibold transition duration-300 ${currentView === 'vendor-products' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Mis Productos
                                </button>
                                <button
                                    onClick={() => setCurrentView('vendor-orders')}
                                    className={`px-5 py-2 rounded-lg font-semibold transition duration-300 ${currentView === 'vendor-orders' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Mis Pedidos
                                </button>
                                <button
                                    onClick={() => { setCurrentView('add-edit-product'); setEditingProduct(null); }}
                                    className={`px-5 py-2 rounded-lg font-semibold transition duration-300 ${currentView === 'add-edit-product' && !editingProduct ? 'bg-indigo-600 text-white shadow-md' : 'bg-green-500 text-white hover:bg-green-600 shadow-md'}`}
                                >
                                    Añadir Nuevo Producto
                                </button>
                            </div>
                        </div>

                        <MessageDisplay msg={message} />

                        {currentView === 'vendor-products' && (
                            <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                                <h3 className="text-2xl font-bold text-gray-800 mb-5">Productos de {vendors.find(v => v.id === currentUser.id)?.name || 'Este Vendedor'}</h3>
                                {vendorProducts.length === 0 ? (
                                    <p className="text-gray-600 text-center py-4">Aún no tienes productos. ¡Añade uno!</p>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {vendorProducts.map(product => (
                                            <div key={product.id} className="bg-gray-50 p-4 rounded-lg shadow-sm flex items-center space-x-4">
                                                <img src={product.imageUrl} alt={product.name} className="w-20 h-20 object-cover rounded-md" onError={(e) => e.target.src = 'https://placehold.co/100x100/CCCCCC/000000?text=Error'} />
                                                <div className="flex-grow">
                                                    <p className="font-semibold text-lg text-gray-900">{product.name}</p>
                                                    <p className="text-gray-700">${product.price.toFixed(2)}</p>
                                                    <p className={`text-sm font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        Stock: {product.stock > 0 ? product.stock : 'Agotado'}
                                                    </p>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => handleEditProduct(product)}
                                                        className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition"
                                                    >
                                                        Editar
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteProduct(product.id)}
                                                        className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition"
                                                    >
                                                        Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'vendor-orders' && (
                            <div className="bg-white p-6 rounded-xl shadow-lg mt-8">
                                <h3 className="text-2xl font-bold text-gray-800 mb-5">Pedidos para {vendors.find(v => v.id === currentUser.id)?.name || 'Este Vendedor'}</h3>
                                {vendorOrders.length === 0 ? (
                                    <p className="text-gray-600 text-center py-4">No hay pedidos para este vendedor.</p>
                                ) : (
                                    <div className="space-y-6">
                                        {vendorOrders.map(order => (
                                            <div key={order.id} className="border p-4 rounded-lg shadow-sm bg-gray-50">
                                                <p className="font-bold text-lg mb-2">Pedido ID: {order.id}</p>
                                                <p className="text-gray-700">Estado: <span className={`font-semibold ${order.status === 'Pendiente' ? 'text-orange-500' : order.status === 'Enviado' ? 'text-blue-500' : 'text-green-500'}`}>{order.status}</span></p>
                                                <p className="text-gray-700 mb-2">Total: ${order.total.toFixed(2)}</p>
                                                <p className="font-semibold text-gray-800 mt-3">Items:</p>
                                                <ul className="list-disc list-inside text-gray-600">
                                                    {order.items.filter(item => item.vendorId === currentUser.id).map(item => (
                                                        <li key={item.id}>{item.name} (x{item.quantity}) - ${item.price.toFixed(2)}</li>
                                                    ))}
                                                </ul>
                                                <div className="mt-4 flex space-x-2">
                                                    <select
                                                        value={order.status}
                                                        onChange={(e) => handleUpdateOrderStatus(order.id, e.target.value)}
                                                        className="p-2 border rounded-md"
                                                    >
                                                        <option value="Pendiente">Pendiente</option>
                                                        <option value="Enviado">Enviado</option>
                                                        <option value="Completado">Completado</option>
                                                        <option value="Cancelado">Cancelado</option>
                                                    </select>
                                                    <button
                                                        onClick={() => handleUpdateOrderStatus(order.id, order.status)} // Trigger update with current selected status
                                                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
                                                    >
                                                        Actualizar
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentView === 'add-edit-product' && (
                            <ProductForm
                                product={editingProduct}
                                onSave={handleAddOrUpdateProduct}
                                onCancel={() => { setCurrentView('vendor-products'); setEditingProduct(null); }}
                            />
                        )}
                    </div>
                );
            };

            const ProductForm = ({ product, onSave, onCancel }) => {
                const [name, setName] = React.useState(product ? product.name : '');
                const [description, setDescription] = React.useState(product ? product.description : '');
                const [price, setPrice] = React.useState(product ? product.price : '');
                const [imageUrl, setImageUrl] = React.useState(product ? product.imageUrl : `https://placehold.co/100x100/CCCCCC/000000?text=Producto`);
                const [stock, setStock] = React.useState(product ? product.stock : 1); // Added stock state

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!name || !description || !price || stock === '' || stock < 0) { // Validate stock
                        setMessage('Por favor, completa todos los campos y asegúrate de que el stock sea un número positivo.');
                        return;
                    }
                    onSave({
                        id: product ? product.id : null,
                        name,
                        description,
                        price: parseFloat(price),
                        imageUrl,
                        stock: parseInt(stock), // Pass stock
                    });
                };

                return (
                    <div className="bg-white p-6 rounded-xl shadow-lg mt-8 max-w-lg mx-auto">
                        <h3 className="text-2xl font-bold text-gray-800 mb-5">{product ? 'Editar Producto' : 'Añadir Nuevo Producto'}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="name" className="block text-gray-700 font-semibold mb-1">Nombre del Producto</label>
                                <input
                                    type="text"
                                    id="name"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="description" className="block text-gray-700 font-semibold mb-1">Descripción</label>
                                <textarea
                                    id="description"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-24"
                                    required
                                ></textarea>
                            </div>
                            <div>
                                <label htmlFor="price" className="block text-gray-700 font-semibold mb-1">Precio</label>
                                <input
                                    type="number"
                                    id="price"
                                    value={price}
                                    onChange={(e) => setPrice(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    step="0.01"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="stock" className="block text-gray-700 font-semibold mb-1">Stock</label>
                                <input
                                    type="number"
                                    id="stock"
                                    value={stock}
                                    onChange={(e) => setStock(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    min="0" // Stock cannot be negative
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="imageUrl" className="block text-gray-700 font-semibold mb-1">URL de la Imagen (opcional)</label>
                                <input
                                    type="text"
                                    id="imageUrl"
                                    value={imageUrl}
                                    onChange={(e) => setImageUrl(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="https://ejemplo.com/imagen.jpg"
                                />
                                {imageUrl && <img src={imageUrl} alt="Vista previa" className="mt-2 w-24 h-24 object-cover rounded-md border border-gray-200" onError={(e) => e.target.src = 'https://placehold.co/100x100/CCCCCC/000000?text=Error'} />}
                            </div>
                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-300 shadow-md"
                                >
                                    Guardar Producto
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };

            const AdminDashboard = () => {
                return (
                    <div className="p-6 bg-gray-50 min-h-screen">
                        <h2 className="text-3xl font-bold text-gray-800 mb-6">Panel de Administrador</h2>
                        <MessageDisplay msg={message} />

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {/* Sección de Productos */}
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">Todos los Productos ({products.length})</h3>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {products.length === 0 ? (
                                        <p className="text-gray-600">No hay productos en el sistema.</p>
                                    ) : (
                                        products.map(product => (
                                            <div key={product.id} className="flex items-center space-x-3 bg-gray-50 p-3 rounded-md shadow-sm">
                                                <img src={product.imageUrl} alt={product.name} className="w-12 h-12 object-cover rounded-md" onError={(e) => e.target.src = 'https://placehold.co/100x100/CCCCCC/000000?text=Error'} />
                                                <div>
                                                    <p className="font-semibold text-gray-900">{product.name}</p>
                                                    <p className="text-sm text-gray-600">Vendedor: {vendors.find(v => v.id === product.vendorId)?.name || 'Desconocido'}</p>
                                                    <p className={`text-sm font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        Stock: {product.stock > 0 ? product.stock : 'Agotado'}
                                                    </p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                            {/* Sección de Pedidos */}
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">Todos los Pedidos ({orders.length})</h3>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {orders.length === 0 ? (
                                        <p className="text-gray-600">No hay pedidos en el sistema.</p>
                                    ) : (
                                        orders.map(order => (
                                            <div key={order.id} className="bg-gray-50 p-3 rounded-md shadow-sm">
                                                <p className="font-semibold">Pedido ID: {order.id}</p>
                                                <p className="text-sm text-gray-700">Cliente: {order.customerId}</p>
                                                <p className="text-sm text-gray-700">Total: ${order.total.toFixed(2)}</p>
                                                <p className="text-sm text-gray-700">Estado: <span className={`font-semibold ${order.status === 'Pendiente' ? 'text-orange-500' : order.status === 'Enviado' ? 'text-blue-500' : 'text-green-500'}`}>{order.status}</span></p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                            {/* Sección de Vendedores */}
                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">Todos los Vendedores ({vendors.length})</h3>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {vendors.map(vendor => (
                                        <div key={vendor.id} className="bg-gray-50 p-3 rounded-md shadow-sm">
                                            <p className="font-semibold">{vendor.name}</p>
                                            <p className="text-sm text-gray-600">ID: {vendor.id}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="font-sans antialiased bg-gray-100">
                    <Header user={currentUser} onLogout={() => { setCurrentUser(null); setCart([]); setEditingProduct(null); setCurrentView('browse'); setMessage(''); }} />

                    {!currentUser && <LoginScreen />}

                    {currentUser?.role === 'customer' && <CustomerDashboard />}
                    {currentUser?.role === 'vendor' && <VendorDashboard />}
                    {currentUser?.role === 'admin' && <AdminDashboard />}
                </div>
            );
        }

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
